# Домашнее задание 4

## 1. Авторизация и обработка форм

Целью домашнего задания является подключение встроенной системы авторизации Django и разработка основных форм добавления данных.

## 2. Срок сдачи

ДЗ3, ДЗ4, ДЗ5 нужно сдать к семинару, на котором выдается ДЗ6. Работы, отправленные на проверку позже, оцениваются в половину максимальных баллов.

До начала занятия, на котором выдается ДЗ6, необходимо:
- пройти ревью у ментора (в формате PR в репозитории) и внести правки;
- передать работу на финальную проверку преподавателям.

## 3. Авторизация и регистрация пользователей

Поскольку мы используем встроенную в Django систему пользователей, имеет смысл использовать готовые методы для логина и регистрации пользователей. Не забывайте, что при создании модели стандартного пользователя User вы должны так же создать связанный Profile, в котором хранятся дополнительные поля.

## 4. Авторизация и регистрация пользователей

### 4.1. Необходимые формы авторизации

- Форма логина. Располагается по URL **/login/**. Пользователь вводит логин/пароль. Дополнительно в GET параметрах передается параметр **next** - URL на который нужно отправить пользователя после успешной авторизации. При неудачной авторизации нужно отображать сообщение об ошибке.
- Форма регистрации. Располагается по URL **/signup/**. Пользователь вводит все необходимые поля (логин, email, имя, пароль). После успешной регистрации отправляется на главную страницу.
- Ссылка “выход”. Располагается на каждой странице в шапке сайта. Видна только авторизованным пользователям. После выхода пользователь остается на текущей странице.
- Форма редактирования профиля. Располагается по URL **/profile/**. Доступна только для авторизованного пользователя. Пользователь видит все необходимые поля: email, nick, avatar. После сохранения остается на странице.

### 4.2. Структура приложения core

Формы авторизации, регистрации и редактирования профиля, а также связанные с ними views, urls, templates должны располагаться в приложении core.

Рекомендуемая структура:
- core/views.py — view для login/signup/profile/logout;
- core/forms.py — формы;
- core/urls.py — маршруты;
- templates/core/ — шаблоны (login.html, signup.html, profile.html, etc).

### 4.3. Параметр ?next= в форме авторизации

В форме логина должен быть корректно реализован параметр ?next= (аналогично тому, как это сделано во встроенных механизмах Django).

Требования:
- после успешной авторизации пользователь перенаправляется на URL из next (если он передан);
- параметр next должен валидироваться: запрещены редиректы на сторонние ресурсы (open redirect). Разрешены только относительные URL вашего сайта или URL, прошедшие проверку средствами Django.

### 4.4. Регистрация и валидация пароля

В форме регистрации должна быть реализована проверка пароля с использованием настроек AUTH_PASSWORD_VALIDATORS.

Требования:
- пароль валидируется стандартными валидаторами Django;
- ошибки валидаторов отображаются пользователю в форме.

## 5. Необходимые формы добавления данных

- Форма добавления вопроса. Располагается по URL **/ask/**. Пользователь вводит название, текст и теги вопроса. После успешного добавления отправляется на страницу вопроса.
- Форма добавления ответа. Располагается на странице вопроса URL **/question/<id>**. Пользователь вводит только текст ответа. После успешного добавления необходимо отправить пользователя на нужную страницу ответов данного вопроса и проскролить страницу так, чтобы добавленный ответ был виден.
- Формы должны быть наследниками ModelForm.

## 6. Требования предъявляемые к формам

### 6.1. Общие требования

Ко всем формам предъявляются следующие требования:
- Обязательна валидация входных данных и вывод сообщений об ошибках.
- При выводе сообщений об ошибках введенные пользователем данные сохраняются, так что нет необходимости вводить их повторно.
- Все формы отправляются с методом POST.
- После успешной обработки формы пользователь отправляется на новую страницу с помощью редиректа.
- Использовать встроенную в Django защиту от **CSRF**.
- Для обработки и вывода форм использовать **django.forms**.

### 6.2. Разделение ответственности: form vs view

Требования к реализации:
- во view не должно быть логики валидации данных — она должна находиться в методах clean() / clean_<field>() формы;
- во view не должно быть логики создания/редактирования сущностей — она должна находиться в save() формы (включая обработку связанных сущностей, например тегов, если вы делаете это в форме).

### 6.3. Состояния фронтенда для авторизованного/неавторизованного пользователя

Должны быть проработаны состояния интерфейса для:
- авторизованного пользователя;
- неавторизованного пользователя.

Требования:
- элементы, недоступные неавторизованному пользователю (например, лайки/добавление вопроса/добавление ответа — в зависимости от вашей логики), должны быть задизейблены;
- у задизейбленных элементов должен быть понятный title/подсказка (почему недоступно и что нужно сделать, например “Войдите, чтобы…”).

## 7. Баллы

### Максимальные баллы за ДЗ - 15 баллов

Вход на сайт (/login/) — 3 балла
- Базовая авторизация (POST, CSRF, редирект после успеха) — 1
- Корректная обработка ?next= (редирект на next после логина, валидация next) — 1
- Отображение ошибок и сохранение введённых данных — 1

Регистрация на сайт (/signup/) — 3 балла
- Создание пользователя + создание связанного Profile — 1
- Валидация пароля через AUTH_PASSWORD_VALIDATORS — 1
- Отображение ошибок и сохранение введённых данных — 1

Выход с сайта (/logout/) — 2 балла
- Logout оставляет пользователя на текущей странице (корректный редирект назад) — 1
- В шапке корректно отображается состояние пользователя (auth/unauth) — 1

Профиль (/profile/) — 3 балла
- Доступ только для авторизованных, корректная обработка GET/POST — 1
- Редактирование email/username (без сохранения аватарки) + отображение ошибок — 1
- Отображение ошибок и сохранение введённых данных, предзаполнение пользовательских данных — 1

Вопросы и ответы (ModelForm) — 2 балла
- Добавление вопроса (/ask/): ModelForm, теги, ошибки, редирект на вопрос — 1
- Добавление ответа (/question/:id/): ModelForm, редирект на нужную страницу ответов/якорь — 1

Обработка состояния неавторизованного пользователя - 2 балла
- Дизейбл/скрытие кнопок и виджетов для неавторизованного пользователя - 1
- Настроенный login_required для вьюх предполагающих авторизацию пользователей - 1

## 8. Полезные ссылки
- Документация по [системе авторизации](https://docs.djangoproject.com/en/5.0/topics/auth/default/);
- [Как войти залогинить пользователя](https://docs.djangoproject.com/en/5.0/topics/auth/default/#how-to-log-a-user-in);
- [Как разлогинить пользователя](https://docs.djangoproject.com/en/5.0/topics/auth/default/#how-to-log-a-user-out);
- [Как зарегистрировать пользователя](https://docs.djangoproject.com/en/5.0/topics/auth/default/#creating-users);
- Туториал по [проектированию форм в Django](https://docs.djangoproject.com/en/5.0/intro/tutorial04/).
