# Домашнее задание 3

## 1. Проектирование модели данных

Целью домашнего задания является проектирование модели базы данных, наполнение ее тестовыми данными и и отображение этих данных на сайте. Таким образом будет создана read-only версия сайта.

## 2. Срок сдачи

ДЗ3, ДЗ4, ДЗ5 нужно сдать к семинару, на котором выдается ДЗ6. Работы, отправленные на проверку позже, оцениваются в половину максимальных баллов.

До начала занятия, на котором выдается ДЗ6, необходимо:
- пройти ревью у ментора (в формате PR в репозитории) и внести правки;
- передать работу на финальную проверку преподавателям.

## 3. Модели приложения

### 3.1. Проектирование модели

Используя Django Models спроектировать схему вашего приложения. Создать модели для основных сущностей: вопрос, ответ, тег, профиль пользователя, лайк. Важно использовать правильные типы данных и проставить необходимые связи ([ForeignKey](https://docs.djangoproject.com/en/5.0/ref/models/fields/#foreignkey)) в моделях. Для вопросов создать свой Model Manager, в котором определить типичные выборки (“лучшие” и “новые” вопросы).

Поскольку мы будем использовать встроенную авторизацию Django (**django.contrib.auth**) - у нас будет готовая модель пользователя (**django.contrib.auth.models.User**), но необходимо создать дополнительную модель (**Profile**) в которую разместить дополнительные поля, например avatar. Модель **Profile** и **User** должны быть связаны один к
одному.

Модели лайков вопросов (**QuestionLike**) и лайков ответов (**AnswerLike**) должны явно описаны в models.py. В этих моделях должны быть заложены ограничения по накрутке лайков - один пользователь одной и той же сущности не может поставить два лайка, в этом случае нужно ограничение на уровне базы [unique_together](https://docs.djangoproject.com/en/5.0/ref/models/options/#unique-together).

### 3.2. Настройка django-admin

В рамках ДЗ3 необходимо настроить административную панель Django.

Требования:
- Админка должна быть доступна по адресу /admin/. Для входа нужно создать суперпользователя командой:
```
python manage.py createsuperuser
```
- Админка должна быть локализована (интерфейс админки — на русском языке).
- В админке должны отображаться все модели, созданные в рамках проектирования (вопросы, ответы, теги, профиль, лайки и т. д.).
- Для моделей должны быть заданы локализованные названия моделей и полей (verbose_name, verbose_name_plural).
- Для каждой модели в списке сущностей должны быть настроены: отображаемые колонки (list_display), удобный поиск (search_fields), фильтрация (list_filter).
- Должны работать страницы создания и редактирования сущностей.
- На странице редактирования пользователя нужно добавить Inline с профилем пользователя.
- На странице редактирования вопроса нужно добавить Inline со списком ответов на вопрос.

Страницы админки должны открываться быстро: не должно быть линейного количества запросов к БД (N+1). При необходимости должны быть настроены raw_id_fields (или аналоги), а также оптимизации запросов.

## 4. ModelManager и методы моделей
В коде view не должно быть кода бизнес логики (анти-паттерн fat controller). Все методы по выборке и сортировке данных - в ModelManager. Вся логика по выводу данных, например построение полного пути к вопросу - в методы модели. Пагинация - в отдельную функцию. Вьюшки должны состоять из 4-6 строк.

## 5. Наполнение данными
Для удобства дальнейшей разработки нужно наполнить базу тестовыми данными. Для этого нужно создать скрипт (а лучше это сделать в виде команды приложения - Management Command), в котором добавить необходимые объекты в базу. При добавлении удобно использовать уже созданные модели, а не писать сырой SQL.

Обратите внимание, что при указании связи в моделях можно использовать как id, так и объекты на которые вы ссылаетесь:
```Python
u = User.objects.get(pk=1)
q = Question(author=u, text='wut?') # ссылка на объект
q.save()
a = Answer(question_id=1, text='blabla') # ссылка по id
a.save()
```
В базе данных в любом случае будут хранится поля вида author_id и question_id.

Требования к объему данных:
- Пользователи > 10 000.
- Вопросы > 100 000.
- Ответы > 1 000 000.
- Тэги > 10 000.
- Оценки пользователей > 2 000 000.

Заполнение должно быть реализовано эффективно:
- не должно быть линейных запросов к БД;
- должны использоваться bulk_create и (при необходимости) bulk_update;
- избегать сохранения объектов по одному в цикле (.save() в больших циклах).

Для генерации тестовых данных должна использоваться библиотека для генерации “человечной рыбы” (например, Faker или аналог).

**Внимание!** Management command должна быть вида: 
```Bash
python manage.py fill_db [ratio]
```
Где num_users — коэффициент заполнения сущностей. Соответственно, после применения команды в базу должно быть добавлено:
 - пользователей — равное ratio;
 - вопросов — ratio * 10;
 - ответы — ratio * 100;
 - тэгов - ratio;
 - оценок пользователей - ratio * 200;

## 6. Отображение данных
Разработать view для отображения следующих страниц:

- Список новых вопросов;
- Список “лучших” вопросов;
- Список вопросов по тегу;
- Страница 1 вопроса со списком ответов.

Для страниц не существующих объектов нужно возвращать 404 страницу. В коде view (контроллеров) не должно быть дублирующегося кода. Использовать функцию пагинации созданную на предыдущем занятии.

Также необходимо проработать состояние пустоты (текстовки "Пока нет ни одного вопроса", "Пока нет ни одного ответа к этому вопросу" и etc) для страниц вашего проекта - первый раз на проверке приложение будет запускаться на пустой БД.

Должна быть установлена django-debug-toolbar, и она должна подключаться только при DEBUG=True. С помощью него можно будет проверить, что в view не будет линейных запросов к БД (N+1):
- использовать select_related, prefetch_related;
- использовать предвыборки и оптимизацию queryset’ов.

Вьюшки должны оставаться “тонкими”: бизнес-логика и типовые выборки — в менеджерах/методах моделей, пагинация — в отдельной функции.

## 7. Рабочее окружение

### 7.1. Использование СУБД
В качестве СУБД по умолчанию в Django используется SQLite. Это встраиваемая СУБД, которая представляет собой файл в каталоге с вашим Django-проектом. Такое решение удобно для отладки, но не может использоваться "в продакшене".

Требуется отказаться от стандартной СУБД SQLite в пользу иной реляционной СУБД на ваш выбор: MySQL или PostgreSQL. Для этого необходимо развернуть локально инстанс СУБД на вашей машине и внести небольшие изменения в конфигурацию проекта Django. См. документацию по ссылкам ниже.

### 7.2. Переменные окружения (.env) и обновление docker-compose

В рамках ДЗ3 выносим конфигурацию в переменные окружения и обновляем Docker-конфигурацию проекта. Нужно создать два файла:
- .env.local — для локального запуска;
- .env.docker — для запуска через docker-compose.

Требования:
- Cекреты должны храниться в .env (например, SECRET_KEY);
- Параметры подключения к БД должны храниться в .env (хост, порт, имя БД, пользователь, пароль).

Обновляем docker-compose.yml:
- добавляем отдельный сервис для БД (PostgreSQL или MySQL);
- настраиваем порядок запуска контейнеров (depends_on);
- настраиваем сеть (дефолтная сеть compose подходит, но конфигурация должна быть корректной);
- прокидываем volume для данных БД, чтобы данные не исчезали при перезапуске контейнеров.

Важно: .env файлы не должны попадать в репозиторий (добавить в .gitignore). При этом в репозитории должен быть пример (например, .env.example) с перечнем переменных без секретных значений.

## 8. Баллы

### Максимальные баллы за ДЗ - 16 баллов

Проектирование модели - 3 балла
- правильные адекватные типы данных, внешние ключи, настроенные ограничения - 1;
- query-set'ы для типовых выборок: новые вопросы, популярные, по тегу - 1;
- настроенная django-admin с локализацией и inline - 1.

Наполнение базы тестовыми данными - 3 балла
- скрипт для наполнения данными с использованием django management commands - 1;
- соблюдение требований по объему (работает при ratio = 10000) и наполнению данных (используется Faker) - 1;
- соблюдение требований к произодительности команды (нет N+1 запросов) - 1.

Отображение списка вопросов и страницы вопроса - 6 баллов
- страницы списка новых вопросов, популярных вопросов, вопросов по тегу - 1;
- пагинация вопросов - 1;
- страница вопроса со списком ответов — 1;
- пагинация ответов - 1;
- обработка 404 и некорректных id - 1;
- обработка состояния пустоты - 1.

Использование СУДБ - 4 балла
- конфигурация проекта через .env - 1 балл
- MySQL или PostgreSQL - 1 балл
- сервис в docker-compose, настроенные network, volume - 2 балла

## 9. Полезные ссылки
- Туториал по [проектированию моделей в Django](https://docs.djangoproject.com/en/5.0/intro/tutorial02/);
- Подробная [документация по моделям](https://docs.djangoproject.com/en/5.0/topics/db/models/);
- Скрипты - [Management Commands](https://docs.djangoproject.com/en/5.0/howto/custom-management-commands/).
- Подключение MySQL к Django - [Databases - MySQL](https://docs.djangoproject.com/en/5.0/ref/databases/#mysql-notes)
- Как поднять MySQL на своей машине с помощью Docker - [Basic Steps for MySQL Server Deployment with Docker](https://dev.mysql.com/doc/mysql-installation-excerpt/8.0/en/docker-mysql-getting-started.html)
- Как настроить MySQL и Djagno приложение - [How To Create a Django App and Connect it to a Database](https://www.digitalocean.com/community/tutorials/how-to-create-a-django-app-and-connect-it-to-a-database)

